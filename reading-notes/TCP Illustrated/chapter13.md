# 第十三章 TCP连接管理

## 13.3 TCP选项

### 13.3.1 最大段大小选项

MSS只记录TCP数据的字节数而不包含其他相关的TCP与IP头部，典型值有536和1460(p.432).MSS不是通信双方协商的结果，而是一个限定的数值，表示允许从对方接受到的最大的报文段。

### 13.3.2 选择确认选项

### 13.3.3 窗口缩放选项

假设我们在使用窗口缩放选项，发送出去的窗口移动数值是S，而接受到的窗口移动数值为R，每接收到对方一个16位的广告窗口左移R位才能得到真实窗口，每次向对方发送窗口通告时都会将32为的窗口大小右移S位

### 13.3.4 时间戳选项

测量RTO，检测伪重传等

## 13.5

## 13.5.2 TIME_WAIT状态

1. TCP能够重新发送最终的ACK以避免出现丢失的情况
2. 让TCP处于等待状态，即通信双方将该连接定义为不可用，只有当2MSL等待结束或者一条新的连接使用的初始序列号超过了连接之前的实例所使用的最高序列号，或者允许用时间戳选项来区分之前的连接实例的报文段。

SO_REUSEADDR套接字选项支持绕开操作

## 13.6 重置报文段

1. 针对不存在端口的连接请求
2. 终止一条连接（SO_LINGER：不会在终止之前为了确定数据到达另一端而逗留任何时间）
3. 另一端奔溃重启，而失去原先连接的信息，写入信息时第一次产生重置报文，第二次产生SIGPIP信号，默认是退出程序
4. 时间等待错误：在TIME_WAIT期间收到旧的报文段，会回复ACK，另一端返回RST重置报文段，使得本段直接到达CLOSED状态。许多系统规定在TIME_WAIT期间不对重置报文段做出反应，从而避免了上述问题。

## 13.7 TCP服务器选项

13.7.4 进入连接队列

传统上，使用伯克利套接字的应用程序能够间接控制未完成连接队列和已完成连接队列的总和，在现代Linux系统内核上，这种行为已经更改已连接队列的总长度。